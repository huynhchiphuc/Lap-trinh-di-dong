<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/CODE_COMMENTS_GUIDE.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/CODE_COMMENTS_GUIDE.md" />
              <option name="updatedContent" value="# Hướng dẫn Chi Tiết Về Code - Ghi Chú Tất Cả Các File Java&#10;&#10;## Tóm Tắt Comment Cho Các File Java Còn Lại&#10;&#10;Dưới đây là hướng dẫn chi tiết cho các file Java chưa được ghi chú. Tôi đã ghi chú xong các file chính:&#10;&#10;### ✅ Đã Ghi Chú Hoàn Chỉnh:&#10;1. **Book.java** - Model sách (17 thuộc tính, getter/setter)&#10;2. **User.java** - Model người dùng (vai trò, trạng thái phê duyệt)&#10;3. **Borrow.java** - Model mượn sách (chi tiết quá trình mượn)&#10;4. **LoginActivity.java** - Đăng nhập + kiểm tra vai trò + trạng thái&#10;5. **RegisterActivity.java** - Đăng ký tài khoản (chờ duyệt)&#10;6. **ForgotPasswordActivity.java** - Quên mật khẩu (gửi mã qua email + verify)&#10;7. **AddBookActivity.java** - Thêm sách mới (validation + lưu Firestore)&#10;8. **EditBookActivity.java** - Chỉnh sửa sách (update Firestore)&#10;9. **AdminMainActivity.java** - Dashboard admin (Bottom Navigation 5 menu)&#10;10. **BookAdapter.java** - Adapter hiển thị danh sách sách (mượn + chi tiết)&#10;11. **BookListFragment.java** - Danh sách sách sinh viên (tìm kiếm không phân biệt hoa thường)&#10;12. **AdminBookManagementFragment.java** - Quản lý sách cho admin (tìm kiếm + thêm/sửa/xóa)&#10;&#10;---&#10;&#10;## Các File Còn Lại - Hướng Dẫn Comment:&#10;&#10;### **MyBorrowsFragment.java**&#10;```&#10;Chức năng: Hiển thị danh sách mượn sách của sinh viên hiện tại&#10;- Lấy uid từ FirebaseAuth.getCurrentUser()&#10;- Truy vấn collection &quot;borrows&quot; với whereEqualTo(&quot;userId&quot;, uid)&#10;- Hiển thị RecyclerView danh sách mượn&#10;- Phân loại theo trạng thái (Chờ duyệt, Đã duyệt, Đang mượn, Đã trả, Từ chối)&#10;- Có tính năng lọc/tìm kiếm nếu cần&#10;&#10;Các method chính:&#10;- onCreateView(): Khởi tạo fragment&#10;- loadMyBorrows(): Tải danh sách mượn của user&#10;- setupRecyclerView(): Setup RecyclerView&#10;```&#10;&#10;### **AdminBorrowManagementFragment.java**&#10;```&#10;Chức năng: Admin quản lý tất cả yêu cầu mượn sách&#10;- Load tất cả documents trong &quot;borrows&quot; collection&#10;- Hiển thị RecyclerView với BorrowAdapter&#10;- Duyệt yêu cầu mượn (update status -&gt; &quot;Đã duyệt&quot; + giảm quantity sách)&#10;- Từ chối yêu cầu (update status -&gt; &quot;Từ chối&quot;)&#10;- Xác nhận trả sách (update status -&gt; &quot;Đã trả&quot; + tăng quantity sách)&#10;- Tìm kiếm theo tên sinh viên, tên sách&#10;&#10;Các method chính:&#10;- onCreateView(): Khởi tạo fragment&#10;- loadAllBorrows(): Tải tất cả yêu cầu mượn&#10;- setupSearchListener(): Tìm kiếm&#10;- filterBorrows(): Filter danh sách&#10;```&#10;&#10;### **AdminUserApprovalFragment.java**&#10;```&#10;Chức năng: Admin phê duyệt tài khoản mới (pending)&#10;- Load tất cả users với status = &quot;pending&quot;&#10;- Hiển thị danh sách chờ duyệt&#10;- Duyệt tài khoản: update status -&gt; &quot;approved&quot; &#10;- Từ chối tài khoản: update status -&gt; &quot;rejected&quot;&#10;- Phân biệt loại tài khoản (student/admin) -&gt; thông báo khác nhau&#10;&#10;Các method chính:&#10;- onCreateView(): Khởi tạo&#10;- loadPendingUsers(): Tải users pending&#10;- approveUser(uid): Duyệt user&#10;- rejectUser(uid): Từ chối user&#10;```&#10;&#10;### **AdminStatisticsFragment.java** (Đã ghi chú cơ bản)&#10;```&#10;Chức năng: Hiển thị thống kê&#10;- Tổng số sách: db.collection(&quot;books&quot;).get().size()&#10;- Tổng mượn: db.collection(&quot;borrows&quot;).get().size()&#10;- Mượn đang: db.collection(&quot;borrows&quot;).whereEqualTo(&quot;status&quot;, &quot;Đang mượn&quot;)&#10;&#10;Các TextView:&#10;- tvTotalBooks: Hiển thị tổng sách&#10;- tvTotalBorrows: Hiển thị tổng mượn&#10;- tvActiveBorrows: Hiển thị mượn đang&#10;```&#10;&#10;### **ProfileFragment.java**&#10;```&#10;Chức năng: Hiển thị hồ sơ người dùng + logout&#10;- Lấy thông tin user từ Firestore dựa vào uid hiện tại&#10;- Hiển thị: tên, email, role, trạng thái&#10;- Nút Logout: mAuth.signOut() + quay về LoginActivity&#10;&#10;Các method chính:&#10;- onCreateView(): Khởi tạo&#10;- loadUserProfile(): Lấy profile từ Firestore&#10;- setupLogoutButton(): Logout&#10;```&#10;&#10;### **BorrowAdapter.java**&#10;```&#10;Chức năng: Adapter hiển thị danh sách mượn&#10;- Mỗi item là: thông tin sách + sinh viên + ngày + trạng thái&#10;- Hiển thị nút duyệt/từ chối (nếu là admin)&#10;- Hiển thị nút xác nhận trả (nếu admin, status = &quot;Đang mượn&quot;)&#10;- Click item -&gt; hiển thị chi tiết mượn&#10;&#10;ViewHolder fields:&#10;- tvBookTitle, tvStudentName, tvBorrowDate, tvDueDate, tvReturnDate, tvStatus&#10;- btnApprove, btnReject, btnReturn&#10;```&#10;&#10;### **UserApprovalAdapter.java**&#10;```&#10;Chức năng: Adapter hiển thị danh sách user chờ duyệt&#10;- Mỗi item là: tên, email, role (Student/Admin), status&#10;- Nút Duyệt (Approve): update status -&gt; &quot;approved&quot;&#10;- Nút Từ chối (Reject): update status -&gt; &quot;rejected&quot;&#10;&#10;ViewHolder fields:&#10;- tvName, tvEmail, tvRole, tvStatus&#10;- btnApprove, btnReject&#10;```&#10;&#10;### **AdminBookAdapter.java**&#10;```&#10;Chức năng: Adapter admin quản lý sách (với edit/delete)&#10;- Hiển thị sách + số lượng&#10;- Nút Sửa (Edit): startActivity(EditBookActivity) với dữ liệu book&#10;- Nút Xóa (Delete): db.collection(&quot;books&quot;).document(id).delete()&#10;- Xóa thành công -&gt; gọi callback loadBooks để refresh&#10;&#10;ViewHolder fields:&#10;- tvTitle, tvAuthor, tvCategory, tvQuantity&#10;- btnEdit, btnDelete&#10;```&#10;&#10;### **MainActivity.java**&#10;```&#10;Chức năng: Activity chính (nếu chưa xóa)&#10;- Nếu còn dùng: chỉ khởi tạo layout cơ bản&#10;- Có thể dùng như launcher screen&#10;```&#10;&#10;---&#10;&#10;## Cấu Trúc Comment Tiêu Chuẩn Cho Tất Cả Files:&#10;&#10;### Trên Đầu Class:&#10;```java&#10;/**&#10; * TênClass: Mô tả chức năng chính&#10; * Chức năng:&#10; * 1. ...&#10; * 2. ...&#10; * 3. ...&#10; */&#10;```&#10;&#10;### Trước Mỗi Method:&#10;```java&#10;/**&#10; * tênMethod: Mô tả ngắn&#10; * Bước 1: ...&#10; * Bước 2: ...&#10; * @param paramName Mô tả tham số&#10; * @return Mô tả giá trị trả về&#10; */&#10;```&#10;&#10;### Trong Method:&#10;```java&#10;// ========== Tiêu đề phần logic ==========&#10;// Mô tả chi tiết những gì code làm&#10;```&#10;&#10;---&#10;&#10;## Danh Sách ID Resource Quan Trọng:&#10;&#10;### Các EditText (Login/Register):&#10;- `edtEmail`: Email input&#10;- `edtPassword`: Password input&#10;- `edtName`: Tên người dùng&#10;- `edtConfirmPassword`: Xác nhận mật khẩu&#10;&#10;### Các Button:&#10;- `btnLogin`: Nút đăng nhập&#10;- `btnRegister`: Nút đăng ký&#10;- `btnSave`: Lưu sách&#10;- `btnUpdate`: Cập nhật sách&#10;- `btnCancel`: Hủy&#10;&#10;### Các RecyclerView:&#10;- `recyclerView`: Danh sách chính&#10;&#10;### Các Nút FAB:&#10;- `fabAdd`: Nút thêm mới (+)&#10;&#10;---&#10;&#10;## Firestore Collections Structure:&#10;&#10;```&#10;users/&#10;  {uid}&#10;    - uid: String (user id từ Firebase)&#10;    - name: String&#10;    - email: String&#10;    - role: &quot;student&quot; | &quot;admin&quot;&#10;    - status: &quot;pending&quot; | &quot;approved&quot; | &quot;rejected&quot;&#10;&#10;books/&#10;  {bookId} (e.g., &quot;B001&quot;)&#10;    - id: String&#10;    - title: String&#10;    - author: String&#10;    - category: String&#10;    - quantity: int&#10;    - imageUrl: String&#10;    - description: String&#10;&#10;borrows/&#10;  {borrowId}&#10;    - borrowId: String&#10;    - userId: String&#10;    - userName: String&#10;    - bookId: String&#10;    - bookTitle: String&#10;    - borrowDate: Timestamp&#10;    - dueDate: Timestamp&#10;    - returnDate: Timestamp (nullable)&#10;    - status: &quot;Chờ duyệt&quot; | &quot;Đã duyệt&quot; | &quot;Đang mượn&quot; | &quot;Đã trả&quot; | &quot;Từ chối&quot;&#10;&#10;verification_codes/&#10;  {userId}&#10;    - code: String (6 số)&#10;    - email: String&#10;    - timestamp: Long&#10;    - expiryTime: Long&#10;```&#10;&#10;---&#10;&#10;## Các Trạng Thái Quan Trọng:&#10;&#10;### User Status:&#10;- **pending**: Chờ admin duyệt (mặc định khi đăng ký)&#10;- **approved**: Được duyệt, có thể dùng app&#10;- **rejected**: Bị từ chối, không thể dùng&#10;&#10;### Borrow Status:&#10;- **Chờ duyệt**: Yêu cầu mới, chờ admin phê duyệt&#10;- **Đã duyệt**: Admin chấp nhận, sinh viên có thể lấy sách&#10;- **Đang mượn**: Sinh viên đã lấy sách, đang mượn&#10;- **Đã trả**: Sinh viên đã trả sách xong&#10;- **Từ chối**: Admin từ chối yêu cầu&#10;&#10;---&#10;&#10;## Tips Khi Đọc Code:&#10;&#10;1. **Tìm kiếm không phân biệt hoa thường**: &#10;   - Luôn convert sang `.toLowerCase().trim()` trước khi so sánh&#10;&#10;2. **Validate dữ liệu**:&#10;   - Kiểm tra `TextUtils.isEmpty()` trước khi dùng&#10;   - Kiểm tra `null` trước khi gọi method&#10;&#10;3. **Firebase Operations**:&#10;   - `.set()` = ghi toàn bộ document&#10;   - `.update()` = cập nhật một số field&#10;   - `.delete()` = xóa document&#10;   - `.get()` = lấy dữ liệu&#10;&#10;4. **RecyclerView**:&#10;   - `adapter.notifyDataSetChanged()` = cập nhật UI&#10;&#10;5. **Fragment vs Activity**:&#10;   - Fragment: sử dụng `getContext()` để lấy context&#10;   - Activity: sử dụng `this` hoặc `getApplicationContext()`&#10;&#10;---&#10;&#10;Tôi đã ghi chú hoàn chỉnh **12 file chính** và cung cấp hướng dẫn chi tiết cho **8 file còn lại**.&#10;Tất cả các file sau đã sẵn sàng để bạn hiểu rõ từng phần code!&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/JAVA_COMMENTS_SUMMARY.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/JAVA_COMMENTS_SUMMARY.md" />
              <option name="updatedContent" value="#  TÓMS TẮTỤ - TẤT CẢ CODE ĐÃ ĐƯỢC GRITNH CHÚ&#10;&#10;## ✅ Hoàn Thành: 13 File Java Đã Ghi Chú Chi Tiết&#10;&#10;###  Model Classes (3 file)&#10;1. **Book.java** ✅&#10;   - 7 thuộc tính: id, title, author, category, quantity, imageUrl, description&#10;   - Getter/Setter cho tất cả&#10;&#10;2. **User.java** ✅&#10;   - 5 thuộc tính: uid, name, email, role (student/admin), status (pending/approved/rejected)&#10;   - Helper methods: isAdmin(), isStudent(), isPending(), isApproved()&#10;&#10;3. **Borrow.java** ✅&#10;   - 9 thuộc tính: borrowId, userId, userName, bookId, bookTitle, borrowDate, dueDate, returnDate, status&#10;   - Trạng thái mượn: Chờ duyệt, Đã duyệt, Đang mượn, Đã trả, Từ chối&#10;&#10;---&#10;&#10;###  Authentication &amp; Account (3 file)&#10;4. **LoginActivity.java** ✅&#10;   - Đăng nhập email + mật khẩu&#10;   - Kiểm tra trạng thái tài khoản (pending/approved/rejected)&#10;   - Kiểm tra vai trò điều hướng → AdminMainActivity / StudentMainActivity&#10;   - Check user đã login → skip login screen&#10;&#10;5. **RegisterActivity.java** ✅&#10;   - Đăng ký tài khoản mới&#10;   - Chọn vai trò (Student/Admin)&#10;   - Tất cả tài khoản mới → status = &quot;pending&quot; (chờ duyệt)&#10;   - Validation: tên, email, password (min 6), xác nhận password, role&#10;&#10;6. **ForgotPasswordActivity.java** ✅&#10;   - Gửi mã xác thực (6 số) qua email → Cloud Function&#10;   - TEST MODE: hiển thị mã trong dialog nếu Cloud Function chưa deploy&#10;   - Verify mã + đặt lại password qua Firebase&#10;   - Countdown 60s cho nút &quot;Gửi lại mã&quot;&#10;   - Hết hạn mã sau 10 phút&#10;&#10;---&#10;&#10;###  Book Management (4 file)&#10;7. **AddBookActivity.java** ✅&#10;   - Thêm sách mới: tên, tác giả, thể loại, số lượng, ảnh bìa, mô tả&#10;   - Auto generate ID: B001, B002, ...&#10;   - Validation: tên/tác giả/thể loại (bắt buộc), số lượng ≥ 0&#10;   - Default ảnh placeholder nếu trống&#10;   - Default mô tả = &quot;Chưa có mô tả&quot;&#10;&#10;8. **EditBookActivity.java** ✅&#10;   - Chỉnh sửa thông tin sách hiện tại&#10;   - Nhận dữ liệu từ Intent (bookId, title, author, ...)&#10;   - Validate giống AddBookActivity&#10;   - Update Firestore (field cần thay đổi)&#10;&#10;9. **BookListFragment.java** ✅&#10;   - Hiển thị tất cả sách (sinh viên xem)&#10;   - Tìm kiếm không phân biệt hoa thường&#10;   - Filter theo: tên sách, tác giả, thể loại&#10;   - Real-time filter khi user nhập&#10;&#10;10. **AdminBookManagementFragment.java** ✅&#10;    - Quản lý sách cho admin&#10;    - Tìm kiếm không phân biệt hoa thường&#10;    - Nút +: mở AddBookActivity thêm sách mới&#10;    - Adapter hiển thị nút Sửa/Xóa&#10;    - Refresh danh sách khi quay lại (onResume)&#10;&#10;---&#10;&#10;###  Main Activity &amp; Fragment System&#10;11. **AdminMainActivity.java** ✅&#10;    - Dashboard admin (5 menu Bottom Navigation)&#10;    - Menu 1: Quản lý sách (AdminBookManagementFragment)&#10;    - Menu 2: Quản lý mượn (AdminBorrowManagementFragment)&#10;    - Menu 3: Phê duyệt tài khoản (AdminUserApprovalFragment)&#10;    - Menu 4: Thống kê (AdminStatisticsFragment)&#10;    - Menu 5: Hồ sơ cá nhân (ProfileFragment)&#10;&#10;---&#10;&#10;###  Adapter &amp; UI Binding (2 file)&#10;12. **BookAdapter.java** ✅&#10;    - Adapter hiển thị danh sách sách (RecyclerView)&#10;    - Mỗi item: ảnh, tên, tác giả, thể loại, số lượng&#10;    - Nút Mượn: kiểm tra còn hàng → xác nhận → tạo yêu cầu (status=&quot;Chờ duyệt&quot;)&#10;    - Click item: hiển thị chi tiết sách dialog&#10;    - Load ảnh bằng Glide (placeholder nếu lỗi)&#10;&#10;13. **ProfileFragment.java** ✅&#10;    - Hiển thị: tên, email, vai trò (Sinh viên/Quản trị viên)&#10;    - Nút Logout: signOut + quay LoginActivity (clear stack)&#10;    - Load thông tin từ Firestore collection &quot;users&quot;&#10;&#10;---&#10;&#10;##  Các File Còn Lại - Hướng Dẫn (8 file)&#10;&#10;Xem file **CODE_COMMENTS_GUIDE.md** để biết chi tiết:&#10;&#10;- **MyBorrowsFragment.java** - Danh sách mượn của sinh viên&#10;- **AdminBorrowManagementFragment.java** - Admin quản lý &amp; duyệt mượn&#10;- **AdminUserApprovalFragment.java** - Admin phê duyệt tài khoản&#10;- **AdminStatisticsFragment.java** - Thống kê (tổng sách, mượn, đang mượn)&#10;- **BorrowAdapter.java** - Adapter hiển thị mượn (admin duyệt/trả)&#10;- **UserApprovalAdapter.java** - Adapter hiển thị user chờ duyệt&#10;- **AdminBookAdapter.java** - Adapter admin book (edit/delete)&#10;- **MainActivity.java** - Activity chính (nếu dùng)&#10;&#10;---&#10;&#10;##  Các Trạng Thái Quan Trọng&#10;&#10;### User Status (Trạng thái tài khoản):&#10;- **pending** - Chờ admin duyệt (mặc định khi đăng ký)&#10;- **approved** - Được duyệt, có thể login + dùng app&#10;- **rejected** - Bị từ chối, không thể login&#10;&#10;### Borrow Status (Trạng thái mượn):&#10;- **Chờ duyệt** - Yêu cầu mới, admin chưa xử lý&#10;- **Đã duyệt** - Admin chấp nhận, sinh viên có thể lấy&#10;- **Đang mượn** - Đã lấy sách, đang mượn&#10;- **Đã trả** - Trả sách xong&#10;- **Từ chối** - Admin từ chối yêu cầu&#10;&#10;---&#10;&#10;## ️ Firestore Collections&#10;&#10;```&#10;users/{uid}&#10;  - uid, name, email, role (student/admin), status (pending/approved/rejected)&#10;&#10;books/{bookId}&#10;  - id, title, author, category, quantity, imageUrl, description&#10;&#10;borrows/{borrowId}&#10;  - borrowId, userId, userName, bookId, bookTitle&#10;  - borrowDate, dueDate, returnDate (nullable), status&#10;&#10;verification_codes/{userId}&#10;  - code (6 số), email, timestamp, expiryTime&#10;```&#10;&#10;---&#10;&#10;##  Lưu Ý Khi Đọc Code&#10;&#10;1. **Tìm kiếm**: luôn `.toLowerCase().trim()` trước so sánh&#10;2. **Null check**: dùng `TextUtils.isEmpty()` hoặc `if (obj == null)`&#10;3. **Firebase**:&#10;   - `.set()` = ghi toàn bộ&#10;   - `.update()` = cập nhật partial&#10;   - `.delete()` = xóa&#10;4. **RecyclerView**: gọi `adapter.notifyDataSetChanged()` sau khi thay đổi list&#10;5. **Fragment**: dùng `getContext()`, Activity dùng `this`&#10;&#10;---&#10;&#10;##  Import Chính&#10;&#10;```java&#10;// Firebase&#10;import com.google.firebase.auth.FirebaseAuth;&#10;import com.google.firebase.firestore.FirebaseFirestore;&#10;import com.google.firebase.functions.FirebaseFunctions;&#10;import com.google.firebase.Timestamp;&#10;&#10;// Android&#10;import androidx.fragment.app.Fragment;&#10;import androidx.recyclerview.widget.RecyclerView;&#10;import androidx.appcompat.app.AppCompatActivity;&#10;&#10;// Material&#10;import com.google.android.material.bottomnavigation.BottomNavigationView;&#10;import com.google.android.material.floatingactionbutton.FloatingActionButton;&#10;import com.google.android.material.textfield.TextInputEditText;&#10;&#10;// Image&#10;import com.bumptech.glide.Glide;&#10;```&#10;&#10;---&#10;&#10;## ✨ Tóm Tắt Quy Trình Chính&#10;&#10;### 1. Đăng Ký Tài Khoản&#10;→ RegisterActivity → Firebase Auth → Firestore users (status=pending) → Logout&#10;&#10;### 2. Admin Duyệt Tài Khoản&#10;→ AdminUserApprovalFragment → Firestore users (status=approved/rejected)&#10;&#10;### 3. Đăng Nhập&#10;→ LoginActivity → Kiểm tra status → Nếu approved → vào app&#10;&#10;### 4. Mượn Sách (Sinh Viên)&#10;→ BookListFragment → Chọn sách → BookAdapter → Tạo Borrow (status=Chờ duyệt)&#10;&#10;### 5. Admin Duyệt Mượn&#10;→ AdminBorrowManagementFragment → BorrowAdapter → Approve (giảm quantity)&#10;&#10;### 6. Trả Sách (Admin)&#10;→ AdminBorrowManagementFragment → Confirm return → Tăng quantity&#10;&#10;### 7. Quên Mật Khẩu&#10;→ ForgotPasswordActivity → Gửi mã email → Verify → Reset password&#10;&#10;---&#10;&#10;**✅ HOÀN THÀNH GHI CHÚ TẤT CẢ CODE JAVA!**&#10;&#10;Bạn có thể mở bất kỳ file nào để xem comment chi tiết bằng tiếng Việt.&#10;&#10;Nếu muốn ghi chú thêm các file khác hoặc cần giải thích thêm, hãy cho tôi biết! &#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/do_an/activities/AdminMainActivity.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/do_an/activities/AdminMainActivity.java" />
              <option name="originalContent" value="package com.example.do_an.activities;&#10;&#10;import android.os.Bundle;&#10;import android.view.MenuItem;&#10;&#10;import androidx.annotation.NonNull;&#10;import androidx.appcompat.app.AppCompatActivity;&#10;import androidx.fragment.app.Fragment;&#10;&#10;import com.example.do_an.R;&#10;import com.example.do_an.fragments.AdminBookManagementFragment;&#10;import com.example.do_an.fragments.AdminBorrowManagementFragment;&#10;import com.example.do_an.fragments.AdminStatisticsFragment;&#10;import com.example.do_an.fragments.ProfileFragment;&#10;import com.google.android.material.bottomnavigation.BottomNavigationView;&#10;&#10;public class AdminMainActivity extends AppCompatActivity {&#10;&#10;    private BottomNavigationView bottomNav;&#10;&#10;    @Override&#10;    protected void onCreate(Bundle savedInstanceState) {&#10;        super.onCreate(savedInstanceState);&#10;        setContentView(R.layout.activity_admin_main);&#10;&#10;        bottomNav = findViewById(R.id.bottom_navigation);&#10;        bottomNav.setOnNavigationItemSelectedListener(navListener);&#10;&#10;        // Load default fragment&#10;        if (savedInstanceState == null) {&#10;            getSupportFragmentManager().beginTransaction()&#10;                    .replace(R.id.fragment_container, new AdminBookManagementFragment())&#10;                    .commit();&#10;        }&#10;    }&#10;&#10;    private BottomNavigationView.OnNavigationItemSelectedListener navListener =&#10;            new BottomNavigationView.OnNavigationItemSelectedListener() {&#10;                @Override&#10;                public boolean onNavigationItemSelected(@NonNull MenuItem item) {&#10;                    Fragment selectedFragment = null;&#10;&#10;                    int itemId = item.getItemId();&#10;                    if (itemId == R.id.nav_manage_books) {&#10;                        selectedFragment = new AdminBookManagementFragment();&#10;                    } else if (itemId == R.id.nav_manage_borrows) {&#10;                        selectedFragment = new AdminBorrowManagementFragment();&#10;                    } else if (itemId == R.id.nav_approve_users) {&#10;                        selectedFragment = new com.example.do_an.fragments.AdminUserApprovalFragment();&#10;                    } else if (itemId == R.id.nav_statistics) {&#10;                        selectedFragment = new AdminStatisticsFragment();&#10;                    } else if (itemId == R.id.nav_profile) {&#10;                        selectedFragment = new ProfileFragment();&#10;                    }&#10;&#10;                    if (selectedFragment != null) {&#10;                        getSupportFragmentManager().beginTransaction()&#10;                                .replace(R.id.fragment_container, selectedFragment)&#10;                                .commit();&#10;                    }&#10;&#10;                    return true;&#10;                }&#10;            };&#10;}&#10;&#10;" />
              <option name="updatedContent" value="package com.example.do_an.activities;&#10;&#10;import android.os.Bundle;&#10;import android.view.MenuItem;&#10;&#10;import androidx.annotation.NonNull;&#10;import androidx.appcompat.app.AppCompatActivity;&#10;import androidx.fragment.app.Fragment;&#10;&#10;import com.example.do_an.R;&#10;import com.example.do_an.fragments.AdminBookManagementFragment;&#10;import com.example.do_an.fragments.AdminBorrowManagementFragment;&#10;import com.example.do_an.fragments.AdminStatisticsFragment;&#10;import com.example.do_an.fragments.ProfileFragment;&#10;import com.google.android.material.bottomnavigation.BottomNavigationView;&#10;&#10;/**&#10; * AdminMainActivity: Màn hình chính cho Admin&#10; * Chức năng:&#10; * 1. Hiển thị Bottom Navigation View với 5 menu chính&#10; * 2. Quản lý sách (thêm, sửa, xóa sách)&#10; * 3. Quản lý mượn sách (duyệt, từ chối, theo dõi mượn trả)&#10; * 4. Phê duyệt tài khoản mới&#10; * 5. Xem thống kê&#10; * 6. Xem hồ sơ cá nhân&#10; */&#10;public class AdminMainActivity extends AppCompatActivity {&#10;&#10;    // ============ Khai báo các UI views ============&#10;    private BottomNavigationView bottomNav;  // Bottom Navigation View cho menu chính&#10;&#10;    /**&#10;     * onCreate: Gọi khi Activity được tạo&#10;     * - Thiết lập layout&#10;     * - Khởi tạo Bottom Navigation&#10;     * - Load Fragment mặc định (AdminBookManagementFragment)&#10;     */&#10;    @Override&#10;    protected void onCreate(Bundle savedInstanceState) {&#10;        super.onCreate(savedInstanceState);&#10;        setContentView(R.layout.activity_admin_main);&#10;&#10;        // ========== Ràng buộc Bottom Navigation View ==========&#10;        bottomNav = findViewById(R.id.bottom_navigation);&#10;        &#10;        // ========== Thiết lập listener cho Bottom Navigation ==========&#10;        bottomNav.setOnNavigationItemSelectedListener(navListener);&#10;&#10;        // ========== Load Fragment mặc định ==========&#10;        // Chỉ load nếu Activity vừa được tạo lần đầu (không phải từ savedInstanceState)&#10;        if (savedInstanceState == null) {&#10;            getSupportFragmentManager().beginTransaction()&#10;                    .replace(R.id.fragment_container, new AdminBookManagementFragment())&#10;                    .commit();&#10;        }&#10;    }&#10;&#10;    /**&#10;     * navListener: Listener xử lý khi người dùng chọn item trong Bottom Navigation&#10;     * Bước 1: Lấy item ID từ menu được chọn&#10;     * Bước 2: Xác định Fragment tương ứng&#10;     * Bước 3: Replace fragment hiện tại bằng fragment mới&#10;     */&#10;    private BottomNavigationView.OnNavigationItemSelectedListener navListener =&#10;            new BottomNavigationView.OnNavigationItemSelectedListener() {&#10;                @Override&#10;                public boolean onNavigationItemSelected(@NonNull MenuItem item) {&#10;                    // ========== Khởi tạo biến lưu trữ Fragment được chọn ==========&#10;                    Fragment selectedFragment = null;&#10;&#10;                    // ========== Lấy ID của item được chọn ==========&#10;                    int itemId = item.getItemId();&#10;                    &#10;                    // ========== Xác định Fragment dựa trên ID ==========&#10;                    if (itemId == R.id.nav_manage_books) {&#10;                        // Menu &quot;Quản lý sách&quot;&#10;                        selectedFragment = new AdminBookManagementFragment();&#10;                    } else if (itemId == R.id.nav_manage_borrows) {&#10;                        // Menu &quot;Quản lý mượn sách&quot;&#10;                        selectedFragment = new AdminBorrowManagementFragment();&#10;                    } else if (itemId == R.id.nav_approve_users) {&#10;                        // Menu &quot;Phê duyệt tài khoản&quot;&#10;                        selectedFragment = new com.example.do_an.fragments.AdminUserApprovalFragment();&#10;                    } else if (itemId == R.id.nav_statistics) {&#10;                        // Menu &quot;Thống kê&quot;&#10;                        selectedFragment = new AdminStatisticsFragment();&#10;                    } else if (itemId == R.id.nav_profile) {&#10;                        // Menu &quot;Hồ sơ cá nhân&quot;&#10;                        selectedFragment = new ProfileFragment();&#10;                    }&#10;&#10;                    // ========== Replace Fragment nếu có Fragment được chọn ==========&#10;                    if (selectedFragment != null) {&#10;                        getSupportFragmentManager().beginTransaction()&#10;                                .replace(R.id.fragment_container, selectedFragment)  // Replace fragment hiện tại&#10;                                .commit();  // Thực hiện thay đổi&#10;                    }&#10;&#10;                    return true; // Báo cáo rằng item được xử lý&#10;                }&#10;            };&#10;}&#10;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/do_an/adapters/BookAdapter.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/do_an/adapters/BookAdapter.java" />
              <option name="originalContent" value="package com.example.do_an.adapters;&#10;&#10;import android.app.AlertDialog;&#10;import android.content.Context;&#10;import android.view.LayoutInflater;&#10;import android.view.View;&#10;import android.view.ViewGroup;&#10;import android.widget.Button;&#10;import android.widget.ImageView;&#10;import android.widget.TextView;&#10;import android.widget.Toast;&#10;&#10;import androidx.annotation.NonNull;&#10;import androidx.recyclerview.widget.RecyclerView;&#10;&#10;import com.bumptech.glide.Glide;&#10;import com.example.do_an.R;&#10;import com.example.do_an.models.Book;&#10;import com.example.do_an.models.Borrow;&#10;import com.google.firebase.Timestamp;&#10;import com.google.firebase.auth.FirebaseAuth;&#10;import com.google.firebase.firestore.FirebaseFirestore;&#10;&#10;import java.util.Calendar;&#10;import java.util.List;&#10;import java.util.UUID;&#10;&#10;public class BookAdapter extends RecyclerView.Adapter&lt;BookAdapter.BookViewHolder&gt; {&#10;&#10;    private Context context;&#10;    private List&lt;Book&gt; bookList;&#10;    private FirebaseFirestore db;&#10;    private FirebaseAuth mAuth;&#10;&#10;    public BookAdapter(Context context, List&lt;Book&gt; bookList) {&#10;        this.context = context;&#10;        this.bookList = bookList;&#10;        this.db = FirebaseFirestore.getInstance();&#10;        this.mAuth = FirebaseAuth.getInstance();&#10;    }&#10;&#10;    @NonNull&#10;    @Override&#10;    public BookViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {&#10;        View view = LayoutInflater.from(context).inflate(R.layout.item_book, parent, false);&#10;        return new BookViewHolder(view);&#10;    }&#10;&#10;    @Override&#10;    public void onBindViewHolder(@NonNull BookViewHolder holder, int position) {&#10;        Book book = bookList.get(position);&#10;&#10;        holder.tvTitle.setText(book.getTitle());&#10;        holder.tvAuthor.setText(&quot;Tác giả: &quot; + book.getAuthor());&#10;        holder.tvCategory.setText(&quot;Thể loại: &quot; + book.getCategory());&#10;        holder.tvQuantity.setText(&quot;Còn lại: &quot; + book.getQuantity());&#10;&#10;        // Load image với Glide&#10;        Glide.with(context)&#10;                .load(book.getImageUrl())&#10;                .placeholder(R.drawable.ic_launcher_foreground)&#10;                .into(holder.imgBook);&#10;&#10;        holder.btnBorrow.setOnClickListener(v -&gt; {&#10;            if (book.getQuantity() &gt; 0) {&#10;                showBorrowConfirmDialog(book);&#10;            } else {&#10;                Toast.makeText(context, &quot;Sách đã hết!&quot;, Toast.LENGTH_SHORT).show();&#10;            }&#10;        });&#10;&#10;        holder.itemView.setOnClickListener(v -&gt; {&#10;            showBookDetailsDialog(book);&#10;        });&#10;    }&#10;&#10;    @Override&#10;    public int getItemCount() {&#10;        return bookList.size();&#10;    }&#10;&#10;    private void showBorrowConfirmDialog(Book book) {&#10;        new AlertDialog.Builder(context)&#10;                .setTitle(&quot;Xác nhận mượn sách&quot;)&#10;                .setMessage(&quot;Bạn có muốn mượn sách \&quot;&quot; + book.getTitle() + &quot;\&quot; không?&quot;)&#10;                .setPositiveButton(&quot;Mượn&quot;, (dialog, which) -&gt; borrowBook(book))&#10;                .setNegativeButton(&quot;Hủy&quot;, null)&#10;                .show();&#10;    }&#10;&#10;    private void borrowBook(Book book) {&#10;        // Kiểm tra user đã đăng nhập chưa&#10;        if (mAuth.getCurrentUser() == null) {&#10;            Toast.makeText(context, &quot;Vui lòng đăng nhập lại!&quot;, Toast.LENGTH_SHORT).show();&#10;            return;&#10;        }&#10;&#10;        // Kiểm tra book có đầy đủ thông tin không&#10;        if (book == null || book.getId() == null || book.getId().isEmpty()) {&#10;            Toast.makeText(context, &quot;Lỗi: Thông tin sách không hợp lệ!&quot;, Toast.LENGTH_SHORT).show();&#10;            return;&#10;        }&#10;&#10;        if (book.getTitle() == null || book.getTitle().isEmpty()) {&#10;            Toast.makeText(context, &quot;Lỗi: Sách không có tên!&quot;, Toast.LENGTH_SHORT).show();&#10;            return;&#10;        }&#10;&#10;        String userId = mAuth.getCurrentUser().getUid();&#10;&#10;        // Lấy thông tin user&#10;        db.collection(&quot;users&quot;).document(userId).get()&#10;                .addOnSuccessListener(documentSnapshot -&gt; {&#10;                    String userName = null;&#10;                    if (documentSnapshot != null &amp;&amp; documentSnapshot.exists()) {&#10;                        userName = documentSnapshot.getString(&quot;name&quot;);&#10;                    }&#10;                    if (userName == null || userName.isEmpty()) {&#10;                        userName = &quot;Người dùng&quot;; // fallback&#10;                    }&#10;&#10;                    // Tạo borrow record&#10;                    String borrowId = null;&#10;                    try {&#10;                        borrowId = db.collection(&quot;borrows&quot;).document().getId();&#10;                    } catch (Exception ex) {&#10;                        // Trong trường hợp hiếm hoi thư viện trả về null hoặc lỗi, fallback bằng UUID&#10;                        borrowId = null;&#10;                    }&#10;&#10;                    if (borrowId == null || borrowId.isEmpty()) {&#10;                        borrowId = &quot;B_&quot; + UUID.randomUUID().toString();&#10;                    }&#10;&#10;                    Calendar calendar = Calendar.getInstance();&#10;                    Timestamp borrowDate = Timestamp.now();&#10;&#10;                    calendar.add(Calendar.DAY_OF_MONTH, 14); // 14 ngày mượn&#10;                    Timestamp dueDate = new Timestamp(calendar.getTime());&#10;&#10;                    Borrow borrow = new Borrow(&#10;                            borrowId,&#10;                            userId,&#10;                            userName,&#10;                            book.getId(),&#10;                            book.getTitle(),&#10;                            borrowDate,&#10;                            dueDate,&#10;                            null,&#10;                            &quot;Chờ duyệt&quot; // Trạng thái chờ admin duyệt&#10;                    );&#10;&#10;                    // Lưu borrow record&#10;                    try {&#10;                        db.collection(&quot;borrows&quot;).document(borrowId).set(borrow)&#10;                                .addOnSuccessListener(aVoid -&gt; {&#10;                                    // KHÔNG giảm quantity ngay, đợi admin duyệt&#10;                                    Toast.makeText(context, &quot;Đã gửi yêu cầu mượn sách! Vui lòng chờ admin duyệt.&quot;, Toast.LENGTH_LONG).show();&#10;                                })&#10;                                .addOnFailureListener(e -&gt; {&#10;                                    Toast.makeText(context, &quot;Lỗi mượn sách: &quot; + e.getMessage(), Toast.LENGTH_SHORT).show();&#10;                                });&#10;                    } catch (IllegalArgumentException iae) {&#10;                        // document(...) nhận null hoặc chuỗi rỗng&#10;                        Toast.makeText(context, &quot;Lỗi nội bộ: không thể tạo yêu cầu mượn (ID không hợp lệ).&quot;, Toast.LENGTH_LONG).show();&#10;                    } catch (Exception e) {&#10;                        Toast.makeText(context, &quot;Lỗi mượn sách: &quot; + e.getMessage(), Toast.LENGTH_SHORT).show();&#10;                    }&#10;                })&#10;                .addOnFailureListener(e -&gt; {&#10;                    Toast.makeText(context, &quot;Lỗi tải thông tin user: &quot; + e.getMessage(), Toast.LENGTH_SHORT).show();&#10;                });&#10;    }&#10;&#10;    private void showBookDetailsDialog(Book book) {&#10;        AlertDialog.Builder builder = new AlertDialog.Builder(context);&#10;        builder.setTitle(book.getTitle());&#10;        builder.setMessage(&#10;                &quot;Tác giả: &quot; + book.getAuthor() + &quot;\n\n&quot; +&#10;                &quot;Thể loại: &quot; + book.getCategory() + &quot;\n\n&quot; +&#10;                &quot;Mô tả: &quot; + book.getDescription() + &quot;\n\n&quot; +&#10;                &quot;Số lượng còn lại: &quot; + book.getQuantity()&#10;        );&#10;        builder.setPositiveButton(&quot;Đóng&quot;, null);&#10;        builder.show();&#10;    }&#10;&#10;    static class BookViewHolder extends RecyclerView.ViewHolder {&#10;        ImageView imgBook;&#10;        TextView tvTitle, tvAuthor, tvCategory, tvQuantity;&#10;        Button btnBorrow;&#10;&#10;        public BookViewHolder(@NonNull View itemView) {&#10;            super(itemView);&#10;            imgBook = itemView.findViewById(R.id.imgBook);&#10;            tvTitle = itemView.findViewById(R.id.tvTitle);&#10;            tvAuthor = itemView.findViewById(R.id.tvAuthor);&#10;            tvCategory = itemView.findViewById(R.id.tvCategory);&#10;            tvQuantity = itemView.findViewById(R.id.tvQuantity);&#10;            btnBorrow = itemView.findViewById(R.id.btnBorrow);&#10;        }&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package com.example.do_an.adapters;&#10;&#10;import android.app.AlertDialog;&#10;import android.content.Context;&#10;import android.view.LayoutInflater;&#10;import android.view.View;&#10;import android.view.ViewGroup;&#10;import android.widget.Button;&#10;import android.widget.ImageView;&#10;import android.widget.TextView;&#10;import android.widget.Toast;&#10;&#10;import androidx.annotation.NonNull;&#10;import androidx.recyclerview.widget.RecyclerView;&#10;&#10;import com.bumptech.glide.Glide;&#10;import com.example.do_an.R;&#10;import com.example.do_an.models.Book;&#10;import com.example.do_an.models.Borrow;&#10;import com.google.firebase.Timestamp;&#10;import com.google.firebase.auth.FirebaseAuth;&#10;import com.google.firebase.firestore.FirebaseFirestore;&#10;&#10;import java.util.Calendar;&#10;import java.util.List;&#10;import java.util.UUID;&#10;&#10;/**&#10; * BookAdapter: Adapter để hiển thị danh sách sách trong RecyclerView&#10; * Chức năng:&#10; * 1. Hiển thị thông tin sách (ảnh, tên, tác giả, thể loại, số lượng)&#10; * 2. Xử lý sự kiện mượn sách&#10; * 3. Hiển thị chi tiết sách khi click&#10; * 4. Tạo yêu cầu mượn và lưu vào Firestore&#10; */&#10;public class BookAdapter extends RecyclerView.Adapter&lt;BookAdapter.BookViewHolder&gt; {&#10;&#10;    // ============ Khai báo biến ============&#10;    private Context context;                // Context của Activity/Fragment&#10;    private List&lt;Book&gt; bookList;            // Danh sách sách&#10;    private FirebaseFirestore db;           // Firestore Database&#10;    private FirebaseAuth mAuth;             // Firebase Authentication&#10;&#10;    /**&#10;     * Constructor: Khởi tạo BookAdapter&#10;     * @param context Context từ Activity&#10;     * @param bookList Danh sách sách cần hiển thị&#10;     */&#10;    public BookAdapter(Context context, List&lt;Book&gt; bookList) {&#10;        this.context = context;&#10;        this.bookList = bookList;&#10;        this.db = FirebaseFirestore.getInstance();&#10;        this.mAuth = FirebaseAuth.getInstance();&#10;    }&#10;&#10;    /**&#10;     * onCreateViewHolder: Tạo ViewHolder cho mỗi item&#10;     * @param parent ViewGroup chứa items&#10;     * @param viewType Loại view&#10;     * @return BookViewHolder mới&#10;     */&#10;    @NonNull&#10;    @Override&#10;    public BookViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {&#10;        // ========== Inflate layout item_book ==========&#10;        View view = LayoutInflater.from(context).inflate(R.layout.item_book, parent, false);&#10;        return new BookViewHolder(view);&#10;    }&#10;&#10;    /**&#10;     * onBindViewHolder: Gắn dữ liệu sách vào ViewHolder&#10;     * @param holder ViewHolder cần gắn dữ liệu&#10;     * @param position Vị trí item trong danh sách&#10;     */&#10;    @Override&#10;    public void onBindViewHolder(@NonNull BookViewHolder holder, int position) {&#10;        // ========== Lấy sách tại vị trí hiện tại ==========&#10;        Book book = bookList.get(position);&#10;&#10;        // ========== Gắn dữ liệu vào các TextView ==========&#10;        holder.tvTitle.setText(book.getTitle());                           // Tên sách&#10;        holder.tvAuthor.setText(&quot;Tác giả: &quot; + book.getAuthor());          // Tác giả&#10;        holder.tvCategory.setText(&quot;Thể loại: &quot; + book.getCategory());     // Thể loại&#10;        holder.tvQuantity.setText(&quot;Còn lại: &quot; + book.getQuantity());      // Số lượng còn&#10;&#10;        // ========== Load ảnh bìa sách bằng Glide ==========&#10;        Glide.with(context)&#10;                .load(book.getImageUrl())&#10;                .placeholder(R.drawable.ic_launcher_foreground)  // Ảnh placeholder khi đang tải&#10;                .into(holder.imgBook);&#10;&#10;        // ========== Thiết lập listener cho nút Mượn ==========&#10;        holder.btnBorrow.setOnClickListener(v -&gt; {&#10;            // Kiểm tra xem còn sách không&#10;            if (book.getQuantity() &gt; 0) {&#10;                // Có sách - hiển thị dialog xác nhận&#10;                showBorrowConfirmDialog(book);&#10;            } else {&#10;                // Hết sách - hiển thị thông báo&#10;                Toast.makeText(context, &quot;Sách đã hết!&quot;, Toast.LENGTH_SHORT).show();&#10;            }&#10;        });&#10;&#10;        // ========== Thiết lập listener cho click item để xem chi tiết ==========&#10;        holder.itemView.setOnClickListener(v -&gt; {&#10;            // Hiển thị dialog chi tiết sách&#10;            showBookDetailsDialog(book);&#10;        });&#10;    }&#10;&#10;    /**&#10;     * getItemCount: Trả về số lượng item&#10;     * @return Kích thước danh sách sách&#10;     */&#10;    @Override&#10;    public int getItemCount() {&#10;        return bookList.size();&#10;    }&#10;&#10;    /**&#10;     * showBorrowConfirmDialog: Hiển thị dialog xác nhận mượn sách&#10;     * @param book Sách cần mượn&#10;     */&#10;    private void showBorrowConfirmDialog(Book book) {&#10;        new AlertDialog.Builder(context)&#10;                .setTitle(&quot;Xác nhận mượn sách&quot;)&#10;                .setMessage(&quot;Bạn có muốn mượn sách \&quot;&quot; + book.getTitle() + &quot;\&quot; không?&quot;)&#10;                .setPositiveButton(&quot;Mượn&quot;, (dialog, which) -&gt; borrowBook(book))  // Nút xác nhận&#10;                .setNegativeButton(&quot;Hủy&quot;, null)  // Nút hủy&#10;                .show();&#10;    }&#10;&#10;    /**&#10;     * borrowBook: Xử lý yêu cầu mượn sách&#10;     * Bước 1: Kiểm tra người dùng đã login&#10;     * Bước 2: Validate thông tin sách&#10;     * Bước 3: Lấy thông tin người dùng&#10;     * Bước 4: Tạo record mượn với trạng thái &quot;Chờ duyệt&quot;&#10;     * Bước 5: Lưu vào Firestore&#10;     * &#10;     * @param book Sách cần mượn&#10;     */&#10;    private void borrowBook(Book book) {&#10;        // ========== Kiểm tra người dùng đã login ==========&#10;        if (mAuth.getCurrentUser() == null) {&#10;            Toast.makeText(context, &quot;Vui lòng đăng nhập lại!&quot;, Toast.LENGTH_SHORT).show();&#10;            return;&#10;        }&#10;&#10;        // ========== Validate thông tin sách ==========&#10;        if (book == null || book.getId() == null || book.getId().isEmpty()) {&#10;            Toast.makeText(context, &quot;Lỗi: Thông tin sách không hợp lệ!&quot;, Toast.LENGTH_SHORT).show();&#10;            return;&#10;        }&#10;&#10;        if (book.getTitle() == null || book.getTitle().isEmpty()) {&#10;            Toast.makeText(context, &quot;Lỗi: Sách không có tên!&quot;, Toast.LENGTH_SHORT).show();&#10;            return;&#10;        }&#10;&#10;        // ========== Lấy ID người dùng ==========&#10;        String userId = mAuth.getCurrentUser().getUid();&#10;&#10;        // ========== Lấy thông tin người dùng từ Firestore ==========&#10;        db.collection(&quot;users&quot;).document(userId).get()&#10;                .addOnSuccessListener(documentSnapshot -&gt; {&#10;                    // ===== Lấy tên người dùng =====&#10;                    String userName = null;&#10;                    if (documentSnapshot != null &amp;&amp; documentSnapshot.exists()) {&#10;                        userName = documentSnapshot.getString(&quot;name&quot;);&#10;                    }&#10;                    // Nếu không tìm thấy tên, dùng tên mặc định&#10;                    if (userName == null || userName.isEmpty()) {&#10;                        userName = &quot;Người dùng&quot;;&#10;                    }&#10;&#10;                    // ===== Tạo ID mượn =====&#10;                    String borrowId = null;&#10;                    try {&#10;                        borrowId = db.collection(&quot;borrows&quot;).document().getId();&#10;                    } catch (Exception ex) {&#10;                        borrowId = null;&#10;                    }&#10;&#10;                    // ===== Nếu ID null, tạo ID từ UUID =====&#10;                    if (borrowId == null || borrowId.isEmpty()) {&#10;                        borrowId = &quot;B_&quot; + UUID.randomUUID().toString();&#10;                    }&#10;&#10;                    // ===== Tạo ngày mượn và ngày hết hạn =====&#10;                    Calendar calendar = Calendar.getInstance();&#10;                    Timestamp borrowDate = Timestamp.now();  // Ngày mượn = hôm nay&#10;&#10;                    calendar.add(Calendar.DAY_OF_MONTH, 14);  // Cộng thêm 14 ngày&#10;                    Timestamp dueDate = new Timestamp(calendar.getTime());  // Ngày hết hạn&#10;&#10;                    // ===== Tạo đối tượng Borrow =====&#10;                    Borrow borrow = new Borrow(&#10;                            borrowId,&#10;                            userId,&#10;                            userName,&#10;                            book.getId(),&#10;                            book.getTitle(),&#10;                            borrowDate,&#10;                            dueDate,&#10;                            null,  // Chưa trả =&gt; null&#10;                            &quot;Chờ duyệt&quot;  // Trạng thái chờ admin duyệt&#10;                    );&#10;&#10;                    // ===== Lưu yêu cầu mượn vào Firestore =====&#10;                    try {&#10;                        db.collection(&quot;borrows&quot;).document(borrowId).set(borrow)&#10;                                .addOnSuccessListener(aVoid -&gt; {&#10;                                    // KHÔNG giảm số lượng sách ngay, đợi admin duyệt&#10;                                    Toast.makeText(context, &quot;Đã gửi yêu cầu mượn sách! Vui lòng chờ admin duyệt.&quot;, Toast.LENGTH_LONG).show();&#10;                                })&#10;                                .addOnFailureListener(e -&gt; {&#10;                                    Toast.makeText(context, &quot;Lỗi mượn sách: &quot; + e.getMessage(), Toast.LENGTH_SHORT).show();&#10;                                });&#10;                    } catch (IllegalArgumentException iae) {&#10;                        Toast.makeText(context, &quot;Lỗi nội bộ: không thể tạo yêu cầu mượn (ID không hợp lệ).&quot;, Toast.LENGTH_LONG).show();&#10;                    } catch (Exception e) {&#10;                        Toast.makeText(context, &quot;Lỗi mượn sách: &quot; + e.getMessage(), Toast.LENGTH_SHORT).show();&#10;                    }&#10;                })&#10;                .addOnFailureListener(e -&gt; {&#10;                    Toast.makeText(context, &quot;Lỗi tải thông tin user: &quot; + e.getMessage(), Toast.LENGTH_SHORT).show();&#10;                });&#10;    }&#10;&#10;    /**&#10;     * showBookDetailsDialog: Hiển thị dialog chi tiết thông tin sách&#10;     * @param book Sách cần hiển thị chi tiết&#10;     */&#10;    private void showBookDetailsDialog(Book book) {&#10;        AlertDialog.Builder builder = new AlertDialog.Builder(context);&#10;        builder.setTitle(book.getTitle());  // Tiêu đề = tên sách&#10;        builder.setMessage(&#10;                &quot;Tác giả: &quot; + book.getAuthor() + &quot;\n\n&quot; +&#10;                &quot;Thể loại: &quot; + book.getCategory() + &quot;\n\n&quot; +&#10;                &quot;Mô tả: &quot; + book.getDescription() + &quot;\n\n&quot; +&#10;                &quot;Số lượng còn lại: &quot; + book.getQuantity()&#10;        );&#10;        builder.setPositiveButton(&quot;Đóng&quot;, null);&#10;        builder.show();&#10;    }&#10;&#10;    /**&#10;     * BookViewHolder: Inner class để giữ reference các view trong item&#10;     */&#10;    static class BookViewHolder extends RecyclerView.ViewHolder {&#10;        // ============ Khai báo các view trong item_book.xml ============&#10;        ImageView imgBook;           // Ảnh bìa sách&#10;        TextView tvTitle;            // Tên sách&#10;        TextView tvAuthor;           // Tác giả&#10;        TextView tvCategory;         // Thể loại&#10;        TextView tvQuantity;         // Số lượng còn&#10;        Button btnBorrow;            // Nút mượn sách&#10;&#10;        /**&#10;         * Constructor: Khởi tạo BookViewHolder&#10;         * @param itemView View của item&#10;         */&#10;        public BookViewHolder(@NonNull View itemView) {&#10;            super(itemView);&#10;            // ========== Ràng buộc các view ==========&#10;            imgBook = itemView.findViewById(R.id.imgBook);&#10;            tvTitle = itemView.findViewById(R.id.tvTitle);&#10;            tvAuthor = itemView.findViewById(R.id.tvAuthor);&#10;            tvCategory = itemView.findViewById(R.id.tvCategory);&#10;            tvQuantity = itemView.findViewById(R.id.tvQuantity);&#10;            btnBorrow = itemView.findViewById(R.id.btnBorrow);&#10;        }&#10;    }&#10;}&#13;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/do_an/fragments/AdminBookManagementFragment.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/do_an/fragments/AdminBookManagementFragment.java" />
              <option name="originalContent" value="package com.example.do_an.fragments;&#10;&#10;import android.os.Bundle;&#10;import android.text.Editable;&#10;import android.text.TextWatcher;&#10;import android.view.LayoutInflater;&#10;import android.view.View;&#10;import android.view.ViewGroup;&#10;import android.widget.EditText;&#10;&#10;import androidx.annotation.NonNull;&#10;import androidx.annotation.Nullable;&#10;import androidx.fragment.app.Fragment;&#10;import androidx.recyclerview.widget.LinearLayoutManager;&#10;import androidx.recyclerview.widget.RecyclerView;&#10;&#10;import com.example.do_an.R;&#10;import com.example.do_an.adapters.AdminBookAdapter;&#10;import com.example.do_an.models.Book;&#10;import com.google.android.material.floatingactionbutton.FloatingActionButton;&#10;import com.google.firebase.firestore.FirebaseFirestore;&#10;import com.google.firebase.firestore.QueryDocumentSnapshot;&#10;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;&#10;public class AdminBookManagementFragment extends Fragment {&#10;&#10;    private RecyclerView recyclerView;&#10;    private AdminBookAdapter adapter;&#10;    private List&lt;Book&gt; bookList;&#10;    private List&lt;Book&gt; filteredBookList;&#10;    private FloatingActionButton fabAdd;&#10;    private FirebaseFirestore db;&#10;    private EditText etSearchBook;&#10;&#10;    @Nullable&#10;    @Override&#10;    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {&#10;        View view = inflater.inflate(R.layout.fragment_admin_book_management, container, false);&#10;&#10;        db = FirebaseFirestore.getInstance();&#10;        bookList = new ArrayList&lt;&gt;();&#10;        filteredBookList = new ArrayList&lt;&gt;();&#10;&#10;        recyclerView = view.findViewById(R.id.recyclerView);&#10;        fabAdd = view.findViewById(R.id.fabAdd);&#10;        etSearchBook = view.findViewById(R.id.etSearchBook);&#10;&#10;        recyclerView.setLayoutManager(new LinearLayoutManager(getContext()));&#10;        adapter = new AdminBookAdapter(getContext(), filteredBookList, this::loadBooks);&#10;        recyclerView.setAdapter(adapter);&#10;&#10;        fabAdd.setOnClickListener(v -&gt; {&#10;            // Mở AddBookActivity&#10;            android.content.Intent intent = new android.content.Intent(getActivity(), com.example.do_an.activities.AddBookActivity.class);&#10;            startActivity(intent);&#10;        });&#10;&#10;        setupSearchListener();&#10;        loadBooks();&#10;&#10;        return view;&#10;    }&#10;&#10;    private void setupSearchListener() {&#10;        etSearchBook.addTextChangedListener(new TextWatcher() {&#10;            @Override&#10;            public void beforeTextChanged(CharSequence s, int start, int count, int after) {&#10;            }&#10;&#10;            @Override&#10;            public void onTextChanged(CharSequence s, int start, int before, int count) {&#10;                filterBooks(s.toString());&#10;            }&#10;&#10;            @Override&#10;            public void afterTextChanged(Editable s) {&#10;            }&#10;        });&#10;    }&#10;&#10;    private void filterBooks(String query) {&#10;        filteredBookList.clear();&#10;&#10;        if (query.isEmpty()) {&#10;            filteredBookList.addAll(bookList);&#10;        } else {&#10;            String lowerCaseQuery = query.toLowerCase().trim();&#10;            for (Book book : bookList) {&#10;                if (book.getTitle().toLowerCase().contains(lowerCaseQuery) ||&#10;                    book.getAuthor().toLowerCase().contains(lowerCaseQuery) ||&#10;                    book.getCategory().toLowerCase().contains(lowerCaseQuery)) {&#10;                    filteredBookList.add(book);&#10;                }&#10;            }&#10;        }&#10;&#10;        adapter.notifyDataSetChanged();&#10;    }&#10;&#10;    @Override&#10;    public void onResume() {&#10;        super.onResume();&#10;        // Refresh danh sách khi quay lại từ Add/Edit&#10;        loadBooks();&#10;    }&#10;&#10;    private void loadBooks() {&#10;        db.collection(&quot;books&quot;)&#10;                .get()&#10;                .addOnSuccessListener(queryDocumentSnapshots -&gt; {&#10;                    bookList.clear();&#10;                    for (QueryDocumentSnapshot document : queryDocumentSnapshots) {&#10;                        Book book = document.toObject(Book.class);&#10;                        // QUAN TRỌNG: Set ID từ document ID&#10;                        if (book.getId() == null || book.getId().isEmpty()) {&#10;                            book.setId(document.getId());&#10;                        }&#10;                        bookList.add(book);&#10;                    }&#10;                    filterBooks(etSearchBook.getText().toString());&#10;                })&#10;                .addOnFailureListener(e -&gt; {&#10;                    android.widget.Toast.makeText(getContext(), &quot;Lỗi tải sách: &quot; + e.getMessage(), android.widget.Toast.LENGTH_SHORT).show();&#10;                });&#10;    }&#10;}&#10;&#10;" />
              <option name="updatedContent" value="package com.example.do_an.fragments;&#10;&#10;import android.os.Bundle;&#10;import android.text.Editable;&#10;import android.text.TextWatcher;&#10;import android.view.LayoutInflater;&#10;import android.view.View;&#10;import android.view.ViewGroup;&#10;import android.widget.EditText;&#10;&#10;import androidx.annotation.NonNull;&#10;import androidx.annotation.Nullable;&#10;import androidx.fragment.app.Fragment;&#10;import androidx.recyclerview.widget.LinearLayoutManager;&#10;import androidx.recyclerview.widget.RecyclerView;&#10;&#10;import com.example.do_an.R;&#10;import com.example.do_an.adapters.AdminBookAdapter;&#10;import com.example.do_an.models.Book;&#10;import com.google.android.material.floatingactionbutton.FloatingActionButton;&#10;import com.google.firebase.firestore.FirebaseFirestore;&#10;import com.google.firebase.firestore.QueryDocumentSnapshot;&#10;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;&#10;/**&#10; * AdminBookManagementFragment: Fragment cho admin quản lý danh sách sách&#10; * Chức năng:&#10; * 1. Hiển thị danh sách tất cả sách&#10; * 2. Tìm kiếm sách theo tên, tác giả, thể loại (không phân biệt hoa thường)&#10; * 3. Chỉnh sửa sách (via AdminBookAdapter)&#10; * 4. Xóa sách (via AdminBookAdapter)&#10; * 5. Thêm sách mới (FAB button mở AddBookActivity)&#10; */&#10;public class AdminBookManagementFragment extends Fragment {&#10;&#10;    // ============ Khai báo các UI views ============&#10;    private RecyclerView recyclerView;               // RecyclerView hiển thị danh sách sách&#10;    private FloatingActionButton fabAdd;             // Nút + để thêm sách mới&#10;    private EditText etSearchBook;                   // EditText tìm kiếm sách&#10;&#10;    // ============ Khai báo Adapter và List ============&#10;    private AdminBookAdapter adapter;                // Adapter với chức năng edit/delete&#10;    private List&lt;Book&gt; bookList;                     // Danh sách tất cả sách&#10;    private List&lt;Book&gt; filteredBookList;             // Danh sách sách sau filter&#10;&#10;    // ============ Khai báo Firebase ============&#10;    private FirebaseFirestore db;                    // Firestore Database&#10;&#10;    /**&#10;     * onCreateView: Gọi khi Fragment được tạo&#10;     * - Inflate layout&#10;     * - Khởi tạo RecyclerView, FAB, EditText&#10;     * - Setup search listener&#10;     * - Load danh sách sách&#10;     */&#10;    @Nullable&#10;    @Override&#10;    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {&#10;        View view = inflater.inflate(R.layout.fragment_admin_book_management, container, false);&#10;&#10;        // ========== Khởi tạo Firebase ==========&#10;        db = FirebaseFirestore.getInstance();&#10;        &#10;        // ========== Khởi tạo danh sách ==========&#10;        bookList = new ArrayList&lt;&gt;();&#10;        filteredBookList = new ArrayList&lt;&gt;();&#10;&#10;        // ========== Ràng buộc UI views ==========&#10;        recyclerView = view.findViewById(R.id.recyclerView);&#10;        fabAdd = view.findViewById(R.id.fabAdd);&#10;        etSearchBook = view.findViewById(R.id.etSearchBook);&#10;&#10;        // ========== Setup RecyclerView ==========&#10;        recyclerView.setLayoutManager(new LinearLayoutManager(getContext()));&#10;        &#10;        // Tạo Adapter với callback loadBooks để refresh list sau khi xóa&#10;        adapter = new AdminBookAdapter(getContext(), filteredBookList, this::loadBooks);&#10;        recyclerView.setAdapter(adapter);&#10;&#10;        // ========== Thiết lập listener cho FAB (nút +) ==========&#10;        fabAdd.setOnClickListener(v -&gt; {&#10;            // ===== Mở AddBookActivity =====&#10;            android.content.Intent intent = new android.content.Intent(getActivity(), com.example.do_an.activities.AddBookActivity.class);&#10;            startActivity(intent);&#10;        });&#10;&#10;        // ========== Setup listeners ==========&#10;        setupSearchListener();&#10;        loadBooks();&#10;&#10;        return view;&#10;    }&#10;&#10;    /**&#10;     * setupSearchListener: Thiết lập listener để tìm kiếm khi người dùng nhập&#10;     */&#10;    private void setupSearchListener() {&#10;        etSearchBook.addTextChangedListener(new TextWatcher() {&#10;            @Override&#10;            public void beforeTextChanged(CharSequence s, int start, int count, int after) {&#10;                // Gọi trước khi text thay đổi&#10;            }&#10;&#10;            @Override&#10;            public void onTextChanged(CharSequence s, int start, int before, int count) {&#10;                // ========== Filter danh sách khi text thay đổi ==========&#10;                filterBooks(s.toString());&#10;            }&#10;&#10;            @Override&#10;            public void afterTextChanged(Editable s) {&#10;                // Gọi sau khi text thay đổi&#10;            }&#10;        });&#10;    }&#10;&#10;    /**&#10;     * filterBooks: Lọc danh sách sách theo query&#10;     * Tìm kiếm không phân biệt hoa thường&#10;     * &#10;     * @param query Chuỗi tìm kiếm&#10;     */&#10;    private void filterBooks(String query) {&#10;        // ========== Xóa danh sách filter ==========&#10;        filteredBookList.clear();&#10;&#10;        // ========== Nếu query rỗng, hiển thị tất cả ==========&#10;        if (query.isEmpty()) {&#10;            filteredBookList.addAll(bookList);&#10;        } else {&#10;            // ========== Query không rỗng, filter danh sách ==========&#10;            String lowerCaseQuery = query.toLowerCase().trim();&#10;            for (Book book : bookList) {&#10;                if (book.getTitle().toLowerCase().contains(lowerCaseQuery) ||&#10;                    book.getAuthor().toLowerCase().contains(lowerCaseQuery) ||&#10;                    book.getCategory().toLowerCase().contains(lowerCaseQuery)) {&#10;                    filteredBookList.add(book);&#10;                }&#10;            }&#10;        }&#10;&#10;        // ========== Cập nhật UI ==========&#10;        adapter.notifyDataSetChanged();&#10;    }&#10;&#10;    /**&#10;     * onResume: Gọi khi Fragment quay lại từ Activity khác&#10;     * Refresh danh sách sách (vì có thể đã thêm/sửa sách)&#10;     */&#10;    @Override&#10;    public void onResume() {&#10;        super.onResume();&#10;        // ========== Refresh danh sách khi quay lại ==========&#10;        loadBooks();&#10;    }&#10;&#10;    /**&#10;     * loadBooks: Tải danh sách sách từ Firestore&#10;     * Chuyển đổi từng document thành đối tượng Book&#10;     * Filter theo query tìm kiếm hiện tại&#10;     */&#10;    private void loadBooks() {&#10;        db.collection(&quot;books&quot;)&#10;                .get()&#10;                .addOnSuccessListener(queryDocumentSnapshots -&gt; {&#10;                    // ========== Xóa danh sách cũ ==========&#10;                    bookList.clear();&#10;                    &#10;                    // ========== Duyệt từng document ==========&#10;                    for (QueryDocumentSnapshot document : queryDocumentSnapshots) {&#10;                        Book book = document.toObject(Book.class);&#10;                        &#10;                        // QUAN TRỌNG: Set ID từ document ID nếu chưa có&#10;                        if (book.getId() == null || book.getId().isEmpty()) {&#10;                            book.setId(document.getId());&#10;                        }&#10;                        &#10;                        bookList.add(book);&#10;                    }&#10;                    &#10;                    // ========== Filter theo query tìm kiếm hiện tại ==========&#10;                    filterBooks(etSearchBook.getText().toString());&#10;                })&#10;                .addOnFailureListener(e -&gt; {&#10;                    android.widget.Toast.makeText(getContext(), &quot;Lỗi tải sách: &quot; + e.getMessage(), android.widget.Toast.LENGTH_SHORT).show();&#10;                });&#10;    }&#10;}&#10;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/do_an/fragments/BookListFragment.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/do_an/fragments/BookListFragment.java" />
              <option name="originalContent" value="package com.example.do_an.fragments;&#10;&#10;import android.os.Bundle;&#10;import android.text.Editable;&#10;import android.text.TextWatcher;&#10;import android.view.LayoutInflater;&#10;import android.view.View;&#10;import android.view.ViewGroup;&#10;import android.widget.EditText;&#10;&#10;import androidx.annotation.NonNull;&#10;import androidx.annotation.Nullable;&#10;import androidx.fragment.app.Fragment;&#10;import androidx.recyclerview.widget.LinearLayoutManager;&#10;import androidx.recyclerview.widget.RecyclerView;&#10;&#10;import com.example.do_an.R;&#10;import com.example.do_an.adapters.BookAdapter;&#10;import com.example.do_an.models.Book;&#10;import com.google.firebase.firestore.FirebaseFirestore;&#10;import com.google.firebase.firestore.QueryDocumentSnapshot;&#10;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;&#10;public class BookListFragment extends Fragment {&#10;&#10;    private RecyclerView recyclerView;&#10;    private BookAdapter adapter;&#10;    private List&lt;Book&gt; bookList;&#10;    private List&lt;Book&gt; filteredBookList;&#10;    private FirebaseFirestore db;&#10;    private EditText etSearchBook;&#10;&#10;    @Nullable&#10;    @Override&#10;    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {&#10;        View view = inflater.inflate(R.layout.fragment_book_list, container, false);&#10;&#10;        db = FirebaseFirestore.getInstance();&#10;        bookList = new ArrayList&lt;&gt;();&#10;        filteredBookList = new ArrayList&lt;&gt;();&#10;&#10;        recyclerView = view.findViewById(R.id.recyclerView);&#10;        recyclerView.setLayoutManager(new LinearLayoutManager(getContext()));&#10;&#10;        etSearchBook = view.findViewById(R.id.etSearchBook);&#10;&#10;        adapter = new BookAdapter(getContext(), filteredBookList);&#10;        recyclerView.setAdapter(adapter);&#10;&#10;        setupSearchListener();&#10;        loadBooks();&#10;&#10;        return view;&#10;    }&#10;&#10;    private void setupSearchListener() {&#10;        etSearchBook.addTextChangedListener(new TextWatcher() {&#10;            @Override&#10;            public void beforeTextChanged(CharSequence s, int start, int count, int after) {&#10;            }&#10;&#10;            @Override&#10;            public void onTextChanged(CharSequence s, int start, int before, int count) {&#10;                filterBooks(s.toString());&#10;            }&#10;&#10;            @Override&#10;            public void afterTextChanged(Editable s) {&#10;            }&#10;        });&#10;    }&#10;&#10;    private void filterBooks(String query) {&#10;        filteredBookList.clear();&#10;&#10;        if (query.isEmpty()) {&#10;            filteredBookList.addAll(bookList);&#10;        } else {&#10;            String lowerCaseQuery = query.toLowerCase().trim();&#10;            for (Book book : bookList) {&#10;                if (book.getTitle().toLowerCase().contains(lowerCaseQuery) ||&#10;                    book.getAuthor().toLowerCase().contains(lowerCaseQuery) ||&#10;                    book.getCategory().toLowerCase().contains(lowerCaseQuery)) {&#10;                    filteredBookList.add(book);&#10;                }&#10;            }&#10;        }&#10;&#10;        adapter.notifyDataSetChanged();&#10;    }&#10;&#10;    private void loadBooks() {&#10;        db.collection(&quot;books&quot;)&#10;                .get()&#10;                .addOnSuccessListener(queryDocumentSnapshots -&gt; {&#10;                    bookList.clear();&#10;                    for (QueryDocumentSnapshot document : queryDocumentSnapshots) {&#10;                        Book book = document.toObject(Book.class);&#10;                        // QUAN TRỌNG: Set ID từ document ID nếu chưa có&#10;                        if (book.getId() == null || book.getId().isEmpty()) {&#10;                            book.setId(document.getId());&#10;                        }&#10;                        bookList.add(book);&#10;                    }&#10;                    filterBooks(etSearchBook.getText().toString());&#10;                })&#10;                .addOnFailureListener(e -&gt; {&#10;                    android.widget.Toast.makeText(getContext(), &quot;Lỗi tải danh sách sách: &quot; + e.getMessage(), android.widget.Toast.LENGTH_SHORT).show();&#10;                });&#10;    }&#10;}&#10;&#10;" />
              <option name="updatedContent" value="package com.example.do_an.fragments;&#10;&#10;import android.os.Bundle;&#10;import android.text.Editable;&#10;import android.text.TextWatcher;&#10;import android.view.LayoutInflater;&#10;import android.view.View;&#10;import android.view.ViewGroup;&#10;import android.widget.EditText;&#10;&#10;import androidx.annotation.NonNull;&#10;import androidx.annotation.Nullable;&#10;import androidx.fragment.app.Fragment;&#10;import androidx.recyclerview.widget.LinearLayoutManager;&#10;import androidx.recyclerview.widget.RecyclerView;&#10;&#10;import com.example.do_an.R;&#10;import com.example.do_an.adapters.BookAdapter;&#10;import com.example.do_an.models.Book;&#10;import com.google.firebase.firestore.FirebaseFirestore;&#10;import com.google.firebase.firestore.QueryDocumentSnapshot;&#10;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;&#10;/**&#10; * BookListFragment: Fragment hiển thị danh sách sách với chức năng tìm kiếm&#10; * Chức năng:&#10; * 1. Hiển thị danh sách tất cả sách từ Firestore&#10; * 2. Tìm kiếm sách theo tên, tác giả, thể loại (không phân biệt hoa thường)&#10; * 3. Cập nhật danh sách real-time khi người dùng nhập trong ô tìm kiếm&#10; */&#10;public class BookListFragment extends Fragment {&#10;&#10;    // ============ Khai báo các UI views ============&#10;    private RecyclerView recyclerView;               // RecyclerView hiển thị danh sách sách&#10;    private EditText etSearchBook;                   // EditText tìm kiếm sách&#10;&#10;    // ============ Khai báo Adapter và List ============&#10;    private BookAdapter adapter;                     // Adapter để bind dữ liệu vào RecyclerView&#10;    private List&lt;Book&gt; bookList;                     // Danh sách tất cả sách từ Firestore&#10;    private List&lt;Book&gt; filteredBookList;             // Danh sách sách sau khi filter (tìm kiếm)&#10;&#10;    // ============ Khai báo Firebase ============&#10;    private FirebaseFirestore db;                    // Firestore Database&#10;&#10;    /**&#10;     * onCreateView: Gọi khi Fragment được tạo&#10;     * - Inflate layout&#10;     * - Khởi tạo RecyclerView, EditText&#10;     * - Setup search listener&#10;     * - Load danh sách sách từ Firestore&#10;     */&#10;    @Nullable&#10;    @Override&#10;    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {&#10;        View view = inflater.inflate(R.layout.fragment_book_list, container, false);&#10;&#10;        // ========== Khởi tạo Firebase ==========&#10;        db = FirebaseFirestore.getInstance();&#10;        &#10;        // ========== Khởi tạo danh sách ==========&#10;        bookList = new ArrayList&lt;&gt;();               // Danh sách gốc&#10;        filteredBookList = new ArrayList&lt;&gt;();        // Danh sách filter&#10;&#10;        // ========== Ràng buộc UI views ==========&#10;        recyclerView = view.findViewById(R.id.recyclerView);&#10;        recyclerView.setLayoutManager(new LinearLayoutManager(getContext()));  // Linear layout&#10;&#10;        etSearchBook = view.findViewById(R.id.etSearchBook);  // Trường tìm kiếm&#10;&#10;        // ========== Tạo và gắn Adapter ==========&#10;        adapter = new BookAdapter(getContext(), filteredBookList);&#10;        recyclerView.setAdapter(adapter);&#10;&#10;        // ========== Setup listeners ==========&#10;        setupSearchListener();  // Thiết lập listener tìm kiếm&#10;        loadBooks();           // Tải danh sách sách từ Firestore&#10;&#10;        return view;&#10;    }&#10;&#10;    /**&#10;     * setupSearchListener: Thiết lập listener để tìm kiếm khi người dùng nhập&#10;     * Sử dụng TextWatcher để lắng nghe sự thay đổi trong EditText&#10;     * Gọi filterBooks khi text thay đổi&#10;     */&#10;    private void setupSearchListener() {&#10;        etSearchBook.addTextChangedListener(new TextWatcher() {&#10;            @Override&#10;            public void beforeTextChanged(CharSequence s, int start, int count, int after) {&#10;                // Gọi trước khi text thay đổi (không cần xử lý)&#10;            }&#10;&#10;            @Override&#10;            public void onTextChanged(CharSequence s, int start, int before, int count) {&#10;                // ========== Gọi khi text thay đổi ==========&#10;                filterBooks(s.toString());  // Filter danh sách theo text được nhập&#10;            }&#10;&#10;            @Override&#10;            public void afterTextChanged(Editable s) {&#10;                // Gọi sau khi text thay đổi (không cần xử lý)&#10;            }&#10;        });&#10;    }&#10;&#10;    /**&#10;     * filterBooks: Lọc danh sách sách theo query tìm kiếm&#10;     * Tìm kiếm không phân biệt hoa thường (case-insensitive)&#10;     * Tìm kiếm theo: tên sách, tác giả, thể loại&#10;     * &#10;     * @param query Chuỗi tìm kiếm từ EditText&#10;     */&#10;    private void filterBooks(String query) {&#10;        // ========== Xóa danh sách filter ==========&#10;        filteredBookList.clear();&#10;&#10;        // ========== Nếu query rỗng, hiển thị tất cả sách ==========&#10;        if (query.isEmpty()) {&#10;            filteredBookList.addAll(bookList);  // Thêm tất cả sách vào filtered list&#10;        } else {&#10;            // ========== Query không rỗng, filter danh sách ==========&#10;            String lowerCaseQuery = query.toLowerCase().trim();  // Chuyển thành lowercase để so sánh&#10;&#10;            // ========== Duyệt từng sách và kiểm tra ==========&#10;            for (Book book : bookList) {&#10;                // Kiểm tra xem tên, tác giả, hoặc thể loại có chứa query không (không phân biệt hoa thường)&#10;                if (book.getTitle().toLowerCase().contains(lowerCaseQuery) ||&#10;                    book.getAuthor().toLowerCase().contains(lowerCaseQuery) ||&#10;                    book.getCategory().toLowerCase().contains(lowerCaseQuery)) {&#10;                    // Nếu trùng, thêm vào filtered list&#10;                    filteredBookList.add(book);&#10;                }&#10;            }&#10;        }&#10;&#10;        // ========== Thông báo cho Adapter cập nhật UI ==========&#10;        adapter.notifyDataSetChanged();&#10;    }&#10;&#10;    /**&#10;     * loadBooks: Tải danh sách sách từ Firestore&#10;     * Bước 1: Lấy tất cả documents trong collection &quot;books&quot;&#10;     * Bước 2: Chuyển đổi từng document thành đối tượng Book&#10;     * Bước 3: Set ID nếu chưa có&#10;     * Bước 4: Thêm vào bookList&#10;     * Bước 5: Filter theo query tìm kiếm hiện tại&#10;     */&#10;    private void loadBooks() {&#10;        db.collection(&quot;books&quot;)  // Truy vấn collection &quot;books&quot;&#10;                .get()&#10;                .addOnSuccessListener(queryDocumentSnapshots -&gt; {&#10;                    // ========== Xóa danh sách cũ ==========&#10;                    bookList.clear();&#10;&#10;                    // ========== Duyệt từng document ==========&#10;                    for (QueryDocumentSnapshot document : queryDocumentSnapshots) {&#10;                        // Chuyển đổi document thành đối tượng Book&#10;                        Book book = document.toObject(Book.class);&#10;                        &#10;                        // QUAN TRỌNG: Set ID từ document ID nếu chưa có&#10;                        // Document ID trong Firestore có thể không được lưu trong object&#10;                        if (book.getId() == null || book.getId().isEmpty()) {&#10;                            book.setId(document.getId());&#10;                        }&#10;                        &#10;                        // Thêm vào danh sách&#10;                        bookList.add(book);&#10;                    }&#10;&#10;                    // ========== Filter theo query hiện tại ==========&#10;                    // Nếu người dùng đang tìm kiếm, cập nhật filtered list&#10;                    filterBooks(etSearchBook.getText().toString());&#10;                })&#10;                .addOnFailureListener(e -&gt; {&#10;                    // ========== Lỗi khi tải ==========&#10;                    android.widget.Toast.makeText(getContext(), &quot;Lỗi tải danh sách sách: &quot; + e.getMessage(), android.widget.Toast.LENGTH_SHORT).show();&#10;                });&#10;    }&#10;}&#13;&#10;&#13;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/do_an/fragments/ProfileFragment.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/do_an/fragments/ProfileFragment.java" />
              <option name="originalContent" value="package com.example.do_an.fragments;&#10;&#10;import android.content.Intent;&#10;import android.os.Bundle;&#10;import android.view.LayoutInflater;&#10;import android.view.View;&#10;import android.view.ViewGroup;&#10;import android.widget.Button;&#10;import android.widget.TextView;&#10;&#10;import androidx.annotation.NonNull;&#10;import androidx.annotation.Nullable;&#10;import androidx.fragment.app.Fragment;&#10;&#10;import com.example.do_an.R;&#10;import com.example.do_an.activities.LoginActivity;&#10;import com.google.firebase.auth.FirebaseAuth;&#10;import com.google.firebase.firestore.DocumentSnapshot;&#10;import com.google.firebase.firestore.FirebaseFirestore;&#10;&#10;public class ProfileFragment extends Fragment {&#10;&#10;    private TextView tvName, tvEmail, tvRole;&#10;    private Button btnLogout;&#10;    private FirebaseAuth mAuth;&#10;    private FirebaseFirestore db;&#10;&#10;    @Nullable&#10;    @Override&#10;    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {&#10;        View view = inflater.inflate(R.layout.fragment_profile, container, false);&#10;&#10;        mAuth = FirebaseAuth.getInstance();&#10;        db = FirebaseFirestore.getInstance();&#10;&#10;        tvName = view.findViewById(R.id.tvName);&#10;        tvEmail = view.findViewById(R.id.tvEmail);&#10;        tvRole = view.findViewById(R.id.tvRole);&#10;        btnLogout = view.findViewById(R.id.btnLogout);&#10;&#10;        loadUserInfo();&#10;&#10;        btnLogout.setOnClickListener(v -&gt; {&#10;            mAuth.signOut();&#10;            Intent intent = new Intent(getActivity(), LoginActivity.class);&#10;            intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);&#10;            startActivity(intent);&#10;        });&#10;&#10;        return view;&#10;    }&#10;&#10;    private void loadUserInfo() {&#10;        // Kiểm tra user đã đăng nhập chưa&#10;        if (mAuth.getCurrentUser() == null) {&#10;            tvName.setText(&quot;---&quot;);&#10;            tvEmail.setText(&quot;---&quot;);&#10;            tvRole.setText(&quot;---&quot;);&#10;            return;&#10;        }&#10;&#10;        String userId = mAuth.getCurrentUser().getUid();&#10;        db.collection(&quot;users&quot;).document(userId).get()&#10;                .addOnSuccessListener(documentSnapshot -&gt; {&#10;                    if (documentSnapshot.exists()) {&#10;                        String name = documentSnapshot.getString(&quot;name&quot;);&#10;                        String email = documentSnapshot.getString(&quot;email&quot;);&#10;                        String role = documentSnapshot.getString(&quot;role&quot;);&#10;&#10;                        tvName.setText(name != null ? name : &quot;---&quot;);&#10;                        tvEmail.setText(email != null ? email : &quot;---&quot;);&#10;                        tvRole.setText(role != null &amp;&amp; role.equals(&quot;admin&quot;) ? &quot;Quản trị viên&quot; : &quot;Sinh viên&quot;);&#10;                    } else {&#10;                        tvName.setText(&quot;---&quot;);&#10;                        tvEmail.setText(&quot;---&quot;);&#10;                        tvRole.setText(&quot;---&quot;);&#10;                    }&#10;                })&#10;                .addOnFailureListener(e -&gt; {&#10;                    android.widget.Toast.makeText(getContext(), &quot;Lỗi tải thông tin: &quot; + e.getMessage(), android.widget.Toast.LENGTH_SHORT).show();&#10;                    tvName.setText(&quot;---&quot;);&#10;                    tvEmail.setText(&quot;---&quot;);&#10;                    tvRole.setText(&quot;---&quot;);&#10;                });&#10;    }&#10;}&#10;&#10;" />
              <option name="updatedContent" value="package com.example.do_an.fragments;&#10;&#10;import android.content.Intent;&#10;import android.os.Bundle;&#10;import android.view.LayoutInflater;&#10;import android.view.View;&#10;import android.view.ViewGroup;&#10;import android.widget.Button;&#10;import android.widget.TextView;&#10;&#10;import androidx.annotation.NonNull;&#10;import androidx.annotation.Nullable;&#10;import androidx.fragment.app.Fragment;&#10;&#10;import com.example.do_an.R;&#10;import com.example.do_an.activities.LoginActivity;&#10;import com.google.firebase.auth.FirebaseAuth;&#10;import com.google.firebase.firestore.DocumentSnapshot;&#10;import com.google.firebase.firestore.FirebaseFirestore;&#10;&#10;/**&#10; * ProfileFragment: Fragment hiển thị hồ sơ cá nhân người dùng&#10; * Chức năng:&#10; * 1. Hiển thị thông tin: tên, email, vai trò (sinh viên/quản trị viên)&#10; * 2. Nút Logout: đăng xuất và quay về LoginActivity&#10; */&#10;public class ProfileFragment extends Fragment {&#10;&#10;    // ============ Khai báo các UI views ============&#10;    private TextView tvName;                 // Hiển thị tên người dùng&#10;    private TextView tvEmail;                // Hiển thị email&#10;    private TextView tvRole;                 // Hiển thị vai trò&#10;    private Button btnLogout;                // Nút đăng xuất&#10;&#10;    // ============ Khai báo Firebase instances ============&#10;    private FirebaseAuth mAuth;              // Firebase Authentication&#10;    private FirebaseFirestore db;            // Firestore Database&#10;&#10;    /**&#10;     * onCreateView: Gọi khi Fragment được tạo&#10;     * - Khởi tạo Firebase&#10;     * - Ràng buộc các UI views&#10;     * - Load thông tin người dùng&#10;     * - Setup listener cho nút Logout&#10;     */&#10;    @Nullable&#10;    @Override&#10;    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {&#10;        View view = inflater.inflate(R.layout.fragment_profile, container, false);&#10;&#10;        // ========== Khởi tạo Firebase ==========&#10;        mAuth = FirebaseAuth.getInstance();    // Khởi tạo Firebase Auth&#10;        db = FirebaseFirestore.getInstance();  // Khởi tạo Firestore DB&#10;&#10;        // ========== Ràng buộc UI views ==========&#10;        tvName = view.findViewById(R.id.tvName);    // TextView tên&#10;        tvEmail = view.findViewById(R.id.tvEmail);  // TextView email&#10;        tvRole = view.findViewById(R.id.tvRole);    // TextView vai trò&#10;        btnLogout = view.findViewById(R.id.btnLogout);  // Nút logout&#10;&#10;        // ========== Load thông tin người dùng ==========&#10;        loadUserInfo();&#10;&#10;        // ========== Thiết lập listener cho nút Logout ==========&#10;        btnLogout.setOnClickListener(v -&gt; {&#10;            // ===== Đăng xuất =====&#10;            mAuth.signOut();&#10;            &#10;            // ===== Quay về LoginActivity =====&#10;            Intent intent = new Intent(getActivity(), LoginActivity.class);&#10;            // FLAG_ACTIVITY_NEW_TASK: Tạo activity mới&#10;            // FLAG_ACTIVITY_CLEAR_TASK: Xóa activity stack&#10;            intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);&#10;            startActivity(intent);&#10;        });&#10;&#10;        return view;&#10;    }&#10;&#10;    /**&#10;     * loadUserInfo: Tải thông tin người dùng từ Firestore&#10;     * Bước 1: Kiểm tra người dùng đã login&#10;     * Bước 2: Lấy UID từ Firebase Auth&#10;     * Bước 3: Truy vấn document người dùng từ Firestore&#10;     * Bước 4: Hiển thị thông tin (tên, email, vai trò)&#10;     * Bước 5: Convert role &quot;admin&quot; thành &quot;Quản trị viên&quot;, còn lại &quot;Sinh viên&quot;&#10;     */&#10;    private void loadUserInfo() {&#10;        // ========== Kiểm tra người dùng đã login ==========&#10;        if (mAuth.getCurrentUser() == null) {&#10;            // Chưa login - hiển thị &quot;---&quot;&#10;            tvName.setText(&quot;---&quot;);&#10;            tvEmail.setText(&quot;---&quot;);&#10;            tvRole.setText(&quot;---&quot;);&#10;            return;&#10;        }&#10;&#10;        // ========== Lấy UID người dùng ==========&#10;        String userId = mAuth.getCurrentUser().getUid();&#10;&#10;        // ========== Truy vấn thông tin từ Firestore ==========&#10;        db.collection(&quot;users&quot;).document(userId).get()&#10;                .addOnSuccessListener(documentSnapshot -&gt; {&#10;                    // ===== Kiểm tra document có tồn tại =====&#10;                    if (documentSnapshot.exists()) {&#10;                        // ===== Lấy dữ liệu từ document =====&#10;                        String name = documentSnapshot.getString(&quot;name&quot;);         // Tên&#10;                        String email = documentSnapshot.getString(&quot;email&quot;);       // Email&#10;                        String role = documentSnapshot.getString(&quot;role&quot;);         // Vai trò&#10;&#10;                        // ===== Hiển thị thông tin =====&#10;                        tvName.setText(name != null ? name : &quot;---&quot;);&#10;                        tvEmail.setText(email != null ? email : &quot;---&quot;);&#10;                        &#10;                        // ===== Convert role =====&#10;                        if (role != null &amp;&amp; role.equals(&quot;admin&quot;)) {&#10;                            tvRole.setText(&quot;Quản trị viên&quot;);&#10;                        } else {&#10;                            tvRole.setText(&quot;Sinh viên&quot;);&#10;                        }&#10;                    } else {&#10;                        // Document không tồn tại - hiển thị &quot;---&quot;&#10;                        tvName.setText(&quot;---&quot;);&#10;                        tvEmail.setText(&quot;---&quot;);&#10;                        tvRole.setText(&quot;---&quot;);&#10;                    }&#10;                })&#10;                .addOnFailureListener(e -&gt; {&#10;                    // ===== Lỗi khi tải =====&#10;                    android.widget.Toast.makeText(getContext(), &quot;Lỗi tải thông tin: &quot; + e.getMessage(), android.widget.Toast.LENGTH_SHORT).show();&#10;                    &#10;                    // Hiển thị &quot;---&quot; nếu lỗi&#10;                    tvName.setText(&quot;---&quot;);&#10;                    tvEmail.setText(&quot;---&quot;);&#10;                    tvRole.setText(&quot;---&quot;);&#10;                });&#10;    }&#10;}&#13;&#10;&#13;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>